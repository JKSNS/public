{ config, pkgs, ... }:

{
  imports = [ ./hardware-configuration.nix ];

  ### System Configuration ###
  boot.loader.grub = {
    enable = true;
    device = "/dev/sda";
    useOSProber = true;
  };

  networking = {
    hostName = "nixos";
    networkmanager.enable = true;
  };

  time.timeZone = "America/Boise";

  i18n.defaultLocale = "en_US.UTF-8";

  ### Logging ###
  services.syslogd.enable = true;

  ### Desktop Environment ###
  services = {
    xserver = {
      enable = true;
      xkb = { layout = "us"; };
    };
    displayManager.sddm.enable = true;
    desktopManager.plasma5.enable = true;
  };

  ### User Management ###
  users.users = {
    nixos = {
      isNormalUser = true;
      description = "nixos";
      extraGroups = [ "networkmanager" "wheel" ];
      packages = with pkgs; [ kdeApplications.kate ];
    };
    CCDCUser1 = {
      isNormalUser = true;
      description = "CCDC Admin User";
      home = "/home/CCDCUser1";
      extraGroups = [ "wheel" ];
      shell = pkgs.bash;
    };
    CCDCUser2 = {
      isNormalUser = true;
      description = "CCDC Limited User";
      home = "/home/CCDCUser2";
      shell = pkgs.bash;
    };
  };

  ### Security ###
  security.audit = {
    enable = true;
    rules = [
      "-w /etc/passwd -p wa -k passwd_changes"
      "-w /etc/shadow -p wa -k shadow_changes"
      "-w /etc/ssh/sshd_config -p wa -k ssh_config_changes"
      "-w /var/log/ -p wa -k log_access"
    ];
  };

  services.openssh = {
    enable = true;
    settings = {
      PermitRootLogin = "no";
      AllowUsers = "CCDCUser1 CCDCUser2";
    };
  };

  ### Firewall ###
  networking.firewall = {
    enable = true;
    allowedTCPPorts = [ 22 80 443 25 110 143 995 ];
    allowedUDPPorts = [ 53 ];
  };

  ### Additional System Packages ###
  environment.systemPackages = with pkgs; [
    vim wget unzip acl rsyslog
  ];

  ### Rsyslog Configuration ###
  services.rsyslog = {
    enable = true;
    extraConfig = ''
      *.* @@splunk.indexer:514
    '';
  };

  ### Splunk Forwarder ###
  systemd.services.splunk-forwarder = {
    description = "Splunk Forwarder Service";
    wantedBy = [ "multi-user.target" ];
    serviceConfig = {
      ExecStart = "${pkgs.bash}/bin/bash -c '${pkgs.wget}/bin/wget -O - https://splunk/indexer-script | bash'";
    };
  };

  ### Scored Services ###
  services = {
    postfix.enable = true;  # Mail server
    httpd.enable = true;    # Apache web server
    nginx.enable = false;   # Disable Nginx to avoid conflicts
  };

  ### System State Version ###
  system.stateVersion = "24.05";
}
